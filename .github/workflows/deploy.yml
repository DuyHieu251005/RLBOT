name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  PROJECT_PATH: /home/hieukieu0543/RLBot

jobs:
  # JOB 1: TEST BACKEND
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics
      - name: Run Pytest (Smoke Tests)
        run: |
          # Set dummy env vars for testing
          export DATABASE_URL="postgresql://user:pass@localhost:5432/db"
          export SERVER_HOST="0.0.0.0" 
          export SERVER_PORT="8000"
          export GEMINI_API_KEY="test_key"
          export SUPABASE_URL="https://example.supabase.co"
          export SUPABASE_ANON_KEY="test"
          export SUPABASE_JWT_SECRET="test_secret"
          export SUPABASE_SERVICE_ROLE_KEY="test_role_key"
          python -m pytest backend/test_main.py

  # JOB 2: TEST FRONTEND
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Type check
        run: cd frontend && npx tsc -b
      - name: Run Unit Tests (Vitest)
        run: cd frontend && npm run test:ci
      - name: Build test
        run: cd frontend && npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}

  # JOB 3: DEPLOY (Only runs if tests pass)
  deploy:
    needs: [test-backend, test-frontend]  # <--- GATED DEPLOYMENT
    runs-on: ubuntu-latest
    name: Deploy to VPS
    if: success() # Double check ensuring previous jobs succeeded

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }}
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ”¨ Rebuilding containers..."
            docker compose -f docker-compose.prod.yml build --no-cache
            
            echo "ðŸš€ Deploying containers..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Health Check
        run: |
          sleep 30
          curl -f https://mc-sv-hcmus.duckdns.org/api/health || echo "âš ï¸ Health check warning (may still be starting)"

